<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Shift & Overtime Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        /* Custom calendar styling */
        .calendar-day {
            min-height: 100px;
            cursor: pointer;
            transition: all 0.2s;
            @apply border border-gray-200 p-2 rounded-lg relative text-sm;<div class="flex items-center text-xs text-indigo-700 mt-1">
           <div class="flex items-center text-xs text-indigo-700 mt-1">
            <p class="font-medium mr-4">Version: <span class="font-bold">1.9b RT</span></p>
            <p id="device-info"></p> 
        </div>
        </div>version
        }
        .calendar-day:hover:not(.day-disabled) {
            @apply shadow-md scale-[1.01] bg-gray-50;
        }
        .day-disabled {
            background-color: #e2e8f0;
            color: #94a3b0;
        }

        /* --- COLOR-CODING BASED ON SHIFT TYPE AND MODIFICATION --- */
        
        /* Standard Weekday (Mon-Fri) */
        .shift-standard-default { background-color: #d1fae5; } /* Light Green (Green 100) */
        .shift-standard-modified { background-color: #6ee7b7; } /* Darker Green (Green 300) */
        
        /* Standard Weekend (Sat/Sun) */
        .shift-weekend-default { background-color: #ffe4c4; } /* Light Orange (Orange 100) */
        .shift-weekend-modified { background-color: #fdba74; } /* Darker Orange (Orange 300) */
        
        /* General Overtime (Non-BH) */
        .shift-overtime-default { background-color: #fbcfe8; } /* Light Pink (Pink 100) */
        .shift-overtime-modified { background-color: #f472b6; } /* Darker Pink (Pink 400) */
        
        /* Bank Holiday Overtime */
        .shift-bh-ot-default { background-color: #f3e8ff; } /* Light Purple (Purple 100) */
        .shift-bh-ot-modified { background-color: #c084fc; } /* Darker Purple (Purple 400) */
        
        /* Bank Holiday (Standard Hours) */
        .shift-bank-holiday { background-color: #e2e8f0; } /* Light Grey (Gray 200) */
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="mb-2">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Personal Shift Tracker     </h1>
        </header>
		
		<p class="text-xs text-right">Version: <span class="font-bold">1.9b RT</span> <span id="device-info"></span></p>
		
        <div id="displayed-profile-section" class="bg-indigo-50 p-4 rounded-xl shadow-inner mb-4 flex justify-between items-center hidden">
            <div class="text-indigo-900 space-y-1">
                <p class="text-sm font-medium">Name: <span id="display-userName" class="font-bold"></span></p>
                <p class="text-sm font-medium">Payroll No: <span id="display-payrollNumber" class="font-bold"></span></p>
                <p class="text-sm font-medium">Email: <span id="display-userEmail" class="font-bold"></span></p>
                <p class="text-sm font-medium">Contracted Hours: <span id="display-contractedHours" class="font-bold"></span></p>
				<div class="flex items-center text-xs text-indigo-700 mt-1"> 
        </div>
            </div>
            <button onclick="editProfile()" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold py-1 px-3 rounded-lg bg-white/50 hover:bg-white transition">
                Change
            </button>
        </div>

        <div id="profile-input-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Details (Saved Locally)</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="userName" placeholder="Your Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="payrollNumber" class="block text-sm font-medium text-gray-700">Payroll Number</label>
                    <input type="text" id="payrollNumber" placeholder="Your Payroll No." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="userEmail" placeholder="username@email.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="contractedHoursSelect" class="block text-sm font-medium text-gray-700">Contracted Hours (Per Week)</label>
                    <select id="contractedHoursSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" onchange="checkCustomContractedHours()">
                        <option value="37.5">37.5 Hours (Default)</option>
                        <option value="25">25.0 Hours</option>
                        <option value="12.5">12.5 Hours</option>
                        <option value="custom">Custom Hours</option>
                    </select>
                </div>
                <div id="customHoursInputContainer" class="hidden">
                    <label for="customContractedHours" class="block text-sm font-medium text-gray-700">Custom Hours</label>
                    <input type="number" step="0.5" id="customContractedHours" placeholder="e.g. 30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div class="flex items-end md:col-span-1">
                    <button onclick="saveProfile()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12 15.75 4.5" /></svg></button>
                <h2 id="current-month-year" class="text-3xl font-bold text-gray-900"></h2>
                <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5 15.75 12 8.25 19.5" /></svg></button>
            </div>
            
            <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-600 mb-2">
                <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                </div>
            
            <div class="mt-6 flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="clearAllShifts()" class="
                    bg-red-600 hover:bg-red-700 text-white font-bold 
                    py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <span>Clear <span id="clear-month-text">Current Month's</span> Shifts</span>
                </button>
                
                <button id="report-button" onclick="generateReport()" class="
                    bg-purple-600 hover:bg-purple-700 text-white font-bold 
                    py-2 px-4 rounded-lg shadow-lg hover:bg-purple-700 transition duration-150 ease-in-out">
                    <span id="report-button-text">Generate Monthly Report</span>
                </button>
            </div>
        </div>

        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl text-center">
                <p id="message-text" class="text-lg font-medium text-gray-700">Loading...</p>
                <button onclick="hideMessageBox()" class="mt-4 bg-indigo-500 text-white py-2 px-4 rounded-lg hidden" id="message-close-btn">Close</button>
            </div>
        </div>
    </div>


    <div id="shift-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-40 p-4">
        <div class="bg-white w-full max-w-lg max-h-[90vh] rounded-xl shadow-2xl p-6 transform transition-all duration-300 overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="modal-date-display">Shift Details for [Date]</h3>
            <p class="text-sm text-gray-500 mb-6">Standard Shift: 07:20 - 20:30 (12.5 hours total, 40 min breaks)</p>
            <form id="shift-form">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Shift Type</label>
                    <div class="mt-1 space-y-2">
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Standard" class="form-radio text-indigo-600 h-4 w-4" checked onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Standard (Weekday/Weekend)</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Overtime" class="form-radio text-red-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Overtime (Non-BH)</span>
                        </label>
                        <hr class="my-1 border-gray-100">
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Bank Holiday" class="form-radio text-blue-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Bank Holiday (Standard Hours)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="shiftType" value="Bank Holiday Overtime" class="form-radio text-purple-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Bank Holiday Overtime</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="startTime" class="block text-sm font-medium text-gray-700">Start Time (HH:MM)</label>
                        <input type="time" id="startTime" value="07:20" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                    </div>

                    <div class="mb-4">
                        <label for="finishTime" class="block text-sm font-medium text-gray-700">Finish Time (HH:MM)</label>
                        <input type="time" id="finishTime" value="20:30" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                    </div>
                </div>

                <div id="breaks-section" class="mb-6 border p-4 rounded-lg bg-gray-50">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Breaks (20 min each)</p>
                    <p class="text-xs text-gray-500 mb-2">Adjustable if shift starts after 13:00 or finishes before 18:00.</p>
                    <label for="breaksCount" class="block text-sm font-medium text-gray-700">Number of Unpaid 20 min Breaks</label>
                    <select id="breaksCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                        <option value="2">2 (40 minutes total - Default)</option>
                        <option value="1">1 (20 minutes total)</option>
                        <option value="0">0 (0 minutes total)</option>
                    </select>
                </div>

                <div id="deviation-selectors" class="mb-6 space-y-3 p-4 border rounded-lg bg-yellow-50/70">
                    <p class="font-bold text-lg mb-2 text-yellow-800">Time Deviation Management</p>
                    </div>

                <div class="mb-6 p-4 border rounded-lg bg-indigo-50">
                    <p class="font-bold text-lg mb-2 text-indigo-700">Calculated Shift Summary</p>
                    <div id="enhancement-display" class="space-y-1 text-sm text-indigo-800">
                        </div>
                </div>

                <div class="flex justify-between items-center pt-4 border-t">
                    <div class="flex space-x-2">
                        <button type="button" onclick="closeShiftModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="button" onclick="deleteShift()" id="delete-shift-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition hidden">Delete Shift</button>
                    </div>
                    <button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">Save Shift</button>
                </div>
            </form>
        </div>
    </div>
    

<div id="report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-40 p-4">
    <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl p-6 transform transition-all duration-300 overflow-y-auto">
        <h3 class="text-2xl font-bold text-gray-800 mb-2" id="report-title">Monthly Shift Report</h3>
        <p class="text-sm text-gray-500 mb-6" id="report-period"></p>

<div class="p-4 border-t border-gray-200 mt-6 flex justify-between items-center">
    
    <div class="flex items-center space-x-2 text-sm">
        <label for="current-print-scale" class="font-medium text-gray-700">PDF Scale:</label>
        <div class="flex items-center">
            <input 
                type="number" 
                id="current-print-scale" 
                min="10" 
                max="200"
                value="100" 
                onchange="changePrintScale()" 
                class="w-16 p-1 border border-gray-300 rounded-l-md text-center focus:ring-indigo-500 focus:border-indigo-500"
            >
            <span class="p-1 border border-l-0 border-gray-300 bg-gray-50 rounded-r-md text-gray-600">%</span>
        </div>
        <button onclick="resetPrintScale()" title="Reset to device default" class="p-1 text-red-500 hover:text-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-4.28 9.22a.75.75 0 0 0 0 1.06l3 3a.75.75 0 1 0 1.06-1.06l-1.72-1.72h5.69a.75.75 0 0 0 0-1.5h-5.69l1.72-1.72a.75.75 0 0 0-1.06-1.06l-3 3Z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    
    <div class="flex space-x-3">
        <button onclick="closeReportModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1.5 px-3 rounded transition">
            Close
        </button>
        <button onclick="showPrintInstructions()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded transition shadow-md">
            Print Report (PDF)
        </button>
    </div>
</div>
		
        <div id="report-content" class="space-y-4">
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="font-semibold text-lg mb-2">Summary Totals (Hours)</p>
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody id="report-table-body" class="divide-y divide-gray-200 text-gray-700">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <p class="font-semibold text-lg mb-4 text-gray-800">Detailed Shift Log</p>
                <div id="detailed-shift-list" class="space-y-3">
                    </div>
            </div>
        </div>
        
        
    </div>
</div>
	
<div id="instruction-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 transform transition-all duration-300">
        <h3 class="text-2xl font-bold text-gray-800 mb-4" id="instruction-modal-title">Print Instructions</h3>
        
        <div id="instruction-content" class="text-gray-700 space-y-4 mb-6">
            </div>

        <div class="flex justify-end space-x-3 pt-4 border-t">
            <button onclick="document.getElementById('instruction-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition">
                Cancel
            </button>
            <button onclick="handlePrintButtonClick()" id="modal-print-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md">
                Print
            </button>
        </div>
    </div>
</div>
<script>
        // --- GLOBAL STATE ---
        let currentYear, currentMonth;
        // UPDATED: Added contractedHours field
        let userProfile = { name: '', payrollNumber: '', userEmail: '', contractedHours: 37.5 };
        let userShifts = {}; // Key: "YYYY-MM-DD", Value: { shiftData }
        let selectedDate = null;
        let currentReportData = { totals: {}, shiftsInMonth: [], monthName: '' }; // Cache for print function

        // Standard shift times
        const DEFAULT_START_TIME_MINUTES = timeToMinutes('07:20');
        const DEFAULT_END_TIME_MINUTES = timeToMinutes('20:30');
        const NIGHT_DUTY_START_MINUTES = timeToMinutes('20:00');
        const NIGHT_DUTY_END_MINUTES = timeToMinutes('20:30');

        // --- LOCAL STORAGE KEY CONSTANTS ---
        const PROFILE_KEY = 'userProfile';
        const SHIFTS_KEY = 'userShifts';

		// Detect if the user is on an Apple device (Mac, iPhone, iPad, iPod)
		const isAppleDevice = /Macintosh|Mac OS|iPhone|iPad|iPod/.test(navigator.userAgent);

		// This will store the active print scale factor (e.g., 1.0 or 0.73).
		// Initialized in loadInitialData()
		let PRINT_SCALE_FACTOR;
			// The default scale for Apple devices
			const APPLE_SCALE = 0.73;
			// The default scale for all other devices
			const DEFAULT_SCALE = 1.0;

		// --- In your <script> block (e.g., in timesheet1.html) ---
			const LOGO_BASE64_SRC = "data:image/png;base64,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y4EHHhgfwfsDAe65865+ttzKykpefP757zx3QlZ2FlOPOILurm7cbjcL5s/n3blzB5R76YUX2FJXj9VqRQIOnzoVqy3xs3jEkUeSk5sbfx767OA7I0kSNpuNObNn09DQ0O+3V195hYatDbHzyTLl5eVYrXse59wX8yvJMj09Pfi6+o+q27dvJxwOI4QgLS2NvF0cudXV1bz//vvxwYAQ3yyaaNr0aXhTUtA0DUna0R+W7R0dXHv1r0lPT+eoadMYPmIEVquFDevX885bb7N161bcLhfbtm3j2OOOozSBEX5vkWSJ8y84n88//RQhBEu/+ooLz7uAy6+8nFElJciyREdHJwvmz+cfL/+Dww4/nD/+6f59cu69JSs7m7PPPZff3XoraWlpvPqPV4hEI5x/wQVkZmZiGAYNjY189smn/OPll7jnvnsT5kjdmZSUFE46+ST+cO99ZGVl0drcwnW//jW/vuZaRhaP4tNP5vHYI48QiUT2S5rGk045ieeffZb6unqam5uZefkVXDHzSg46+GCsViuBQIDKlZXMeX02alTjlddfw2azUdibWlOSJHTd4N677+Hqa67G7XFTX7eZvzzwANXV1WRmZhLwB9A0FaN3xJuXl8cpp57Cfffcg9vtprOjg4t/dSGXXHopB/5oMoau88UXX5Cdlc055537vU/0cvqMGTz7zDP4un04nU7mz5/PL3/+c44/4UTa29t46803aWpsIi0t7TvNAifLMuecdy7vvPU23b5ubDYbd952O40NjRx+xFRCwSDvzp3Lyy++hNvjoburi0k/mswZM2YAsdnJI39/GKvNxjHHHI3H6yEaVZn96mvUbtoUf15KSksGHXk7HA5qamqYefkVXH7FFeQX5POfjz7i0UcexW63x6MlTj3ttAHHJmNY0XDC4TCpqak0Nzfzxz/cx1nnnEPDlq0cetgURowYgdViwRCCxsZGHvzr3zj/gvOxWK3UrFnDH+65l5bmFjIyMgj4A/HZ/u5irdva2vjrA39h3IRxHHTQQdgdDvx+Pw/++S90tG/HarOiGwYlJSUAWOpqawkFgzQ1NlK5cmXsRMS+HHa7PR7sPGrUKG793e8Sr8hK8hAl+uWoadO47sYb+OO99yHLMgsXLuDLL78kJ2cIikWhra2dUDBIJBzhx4ccsgfd/u1xwa9+xZrVq5n92mukpKQw57XZ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";
	
        // --- UTILITY FUNCTIONS ---
		// --- DEVICE DETECTION ---

/**
 * @description Detects and returns the user's device type and browser name.
 * @returns {string} Formatted string like "Device: Windows PC, Browser: Chrome"
 */
function detectDeviceAndBrowser() {
    const userAgent = navigator.userAgent;
    let device = 'Unknown Device';
    let browser = 'Unknown Browser';

    // 1. Detect Device Type
    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        device = 'iOS (iPhone/iPad)';
    } else if (/Android/.test(userAgent)) {
        device = 'Android Mobile';
    } else if (/Macintosh|Mac OS X/.test(userAgent)) {
        device = 'Mac/OSX PC';
    } else if (/Windows/.test(userAgent)) {
        device = 'Windows PC';
    } else if (/Linux/.test(userAgent)) {
        device = 'Linux PC';
    } else if (/CrOS/.test(userAgent)) {
        device = 'ChromeOS';
    }

    // 2. Detect Browser
    if (userAgent.indexOf("Edg") !== -1) {
        browser = "Microsoft Edge";
    } else if (userAgent.indexOf("Chrome") !== -1 && userAgent.indexOf("Edg") === -1) {
        // Check for Edge first, then Chrome
        browser = "Google Chrome";
    } else if (userAgent.indexOf("Safari") !== -1) {
        // Must check Safari after Chrome/Edge as they also contain "Safari"
        browser = "Safari";
    } else if (userAgent.indexOf("Firefox") !== -1) {
        browser = "Mozilla Firefox";
    } else if (userAgent.indexOf("Trident") !== -1 || userAgent.indexOf("MSIE") !== -1) {
        browser = "Internet Explorer";
    }

    return `System: ${device}, Browser: ${browser}`;
}

/**
 * @description Classifies the user's system into a category for printing instructions.
 * @returns {string} One of: 'Apple', 'Android', 'WindowsPC' (or 'OtherPC')
 */
function classifyDeviceForInstructions() {
    const userAgent = navigator.userAgent;
    const isWindows = /Windows/i.test(userAgent);
    const isAndroid = /Android/i.test(userAgent);
    const isMacOriOS = /Macintosh|Mac OS X|iPhone|iPad|iPod/i.test(userAgent);

    if (isMacOriOS) {
        return 'Apple'; // Covers both iOS (mobile) and macOS (desktop)
    } else if (isAndroid) {
        return 'Android';
    } else if (isWindows) {
        return 'WindowsPC';
    } else {
        return 'OtherPC'; // Covers Linux, ChromeOS, etc.
    }
}
		
        // Helper: Convert "HH:MM" string to minutes from midnight
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        // Helper: Convert minutes to decimal hours (two decimal places)
        function minutesToDecimalHours(minutes) {
            return (minutes / 60);
        }
        
        // Helper: Format hours for display
function formatHours(minutes) {
    // FIX: Check if the input is a valid, finite number.
    if (!Number.isFinite(minutes)) {
        return '0.00'; // Return a safe default string (e.g., '0.00') instead of 'NaN'
    }
    return minutesToDecimalHours(minutes).toFixed(2); // If valid, proceed as normal
}
        
        // Helper: Format hours for the print form (blank if zero)
        function formatHoursForPrint(minutes) {
            return minutes > 0.01 ? minutesToDecimalHours(minutes).toFixed(2) : '';
        }

        function showMessageBox(title, message, closable = false) {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').innerHTML = `<strong>${title}:</strong> ${message}`;
            const closeBtn = document.getElementById('message-close-btn');
            if (closable) {
                closeBtn.classList.remove('hidden');
                closeBtn.onclick = hideMessageBox;
            } else {
                closeBtn.classList.add('hidden');
            }
            box.classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- LOCAL STORAGE DATA HANDLING ---

        function loadInitialData() {
            // Load Print Scale from Local Storage
    const storedScale = localStorage.getItem('printScaleFactor');
    if (storedScale) {
        PRINT_SCALE_FACTOR = parseFloat(storedScale);
    } else {
        // If no scale is stored, apply the device-specific default
        PRINT_SCALE_FACTOR = isAppleDevice ? APPLE_SCALE : DEFAULT_SCALE;
    }

    // Set the display text for the scale button/input if it exists
    const scaleDisplayElement = document.getElementById('current-print-scale');
    if (scaleDisplayElement) {
        scaleDisplayElement.value = (PRINT_SCALE_FACTOR * 100).toFixed(0); // Display as percentage (e.g., 73)
    }
			
			// Load Profile
            const storedProfile = localStorage.getItem(PROFILE_KEY);
            if (storedProfile) {
                try {
                    const parsedProfile = JSON.parse(storedProfile);
                    userProfile = {
                        name: parsedProfile.name || '',
                        payrollNumber: parsedProfile.payrollNumber || '',
                        userEmail: parsedProfile.userEmail || 'username@email.com',
                        // NEW: Load contractedHours, default to 37.5 if missing
                        contractedHours: parseFloat(parsedProfile.contractedHours) || 37.5
                    };
                    
                    document.getElementById('userName').value = userProfile.name;
                    document.getElementById('payrollNumber').value = userProfile.payrollNumber;
                    document.getElementById('userEmail').value = userProfile.userEmail;

                    // NEW: Set contracted hours in the select/custom input
                    const hours = userProfile.contractedHours;
                    const select = document.getElementById('contractedHoursSelect');
                    const customInput = document.getElementById('customContractedHours');

                    // Find if the stored value is in the default options
                    const options = Array.from(select.options).map(opt => opt.value);
                    if (options.includes(String(hours))) {
                        select.value = String(hours);
                        document.getElementById('customHoursInputContainer').classList.add('hidden');
                    } else {
                        // It's a custom value
                        select.value = 'custom';
                        customInput.value = hours;
                        document.getElementById('customHoursInputContainer').classList.remove('hidden');
                    }


                } catch (e) {
                    console.error("Error parsing stored profile:", e);
                }
            } else {
                // If no profile exists, set the defaults
                userProfile.userEmail = 'username@email.com';
                document.getElementById('userEmail').value = 'username@email.com';
                document.getElementById('contractedHoursSelect').value = '37.5';
            }
            
            // Call profile display update after loading
            updateProfileDisplay();

            // Load Shifts
            const storedShifts = localStorage.getItem(SHIFTS_KEY);
            if (storedShifts) {
                try {
                    userShifts = JSON.parse(storedShifts);
                } catch (e) {
                    console.error("Error parsing stored shifts:", e);
                    userShifts = {};
                }
            }

            renderCalendar(); // Initial render after loading data
        }
        
        function updateProfileDisplay() {
            const inputSection = document.getElementById('profile-input-section');
            const displaySection = document.getElementById('displayed-profile-section');
            
            if (userProfile.name && userProfile.payrollNumber) {
                // Show display, hide input
                document.getElementById('display-userName').textContent = userProfile.name;
                document.getElementById('display-payrollNumber').textContent = userProfile.payrollNumber;
                document.getElementById('display-userEmail').textContent = userProfile.userEmail; 
                // NEW: Display contracted hours
                document.getElementById('display-contractedHours').textContent = `${userProfile.contractedHours} Hours`;
                // NEW: Display device and browser info
                document.getElementById('device-info').textContent = detectDeviceAndBrowser();
				
                displaySection.classList.remove('hidden');
                inputSection.classList.add('hidden');
            } else {
                // Show input, hide display
                inputSection.classList.remove('hidden');
                displaySection.classList.add('hidden');
            }
        }
        
        window.checkCustomContractedHours = function() {
            const select = document.getElementById('contractedHoursSelect');
            const customContainer = document.getElementById('customHoursInputContainer');
            if (select.value === 'custom') {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
        }

        window.editProfile = function() {
            // Restore current values to inputs before showing
            document.getElementById('userName').value = userProfile.name || '';
            document.getElementById('payrollNumber').value = userProfile.payrollNumber || '';
            document.getElementById('userEmail').value = userProfile.userEmail || 'username@email.com';
            
            const hours = userProfile.contractedHours;
            const select = document.getElementById('contractedHoursSelect');
            const customInput = document.getElementById('customContractedHours');
            const customContainer = document.getElementById('customHoursInputContainer');

            // Find if the stored value is in the default options
            const options = Array.from(select.options).map(opt => opt.value);
            if (options.includes(String(hours))) {
                select.value = String(hours);
                customContainer.classList.add('hidden');
            } else {
                select.value = 'custom';
                customInput.value = hours;
                customContainer.classList.remove('hidden');
            }
            
            document.getElementById('profile-input-section').classList.remove('hidden');
            document.getElementById('displayed-profile-section').classList.add('hidden');
        }

        window.saveProfile = function() {
            const name = document.getElementById('userName').value.trim();
            const payrollNumber = document.getElementById('payrollNumber').value.trim();
            const userEmail = document.getElementById('userEmail').value.trim();
            const hoursSelect = document.getElementById('contractedHoursSelect').value;
            let contractedHours;

            if (hoursSelect === 'custom') {
                const customHoursInput = document.getElementById('customContractedHours').value;
                contractedHours = parseFloat(customHoursInput) || 37.5; // Default if custom input is bad
            } else {
                contractedHours = parseFloat(hoursSelect) || 37.5;
            }
            
            if (!name || !payrollNumber) {
                showMessageBox("Input Required", "Please enter both your Name and Payroll Number before saving.", true);
                return;
            }

            userProfile = {
                name: name,
                payrollNumber: payrollNumber,
                userEmail: userEmail,
                contractedHours: contractedHours
            };

            try {
                localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
                showMessageBox("Success", "Profile details saved successfully in your browser's local storage.", true);
            } catch (error) {
                showMessageBox("Error", "Could not save profile. Check your browser settings for local storage/cookies.", true);
                console.error("Error saving profile:", error);
            }
            
            updateProfileDisplay(); // Switch back to display mode
        }

        function saveShiftsToLocalStorage() {
            try {
                localStorage.setItem(SHIFTS_KEY, JSON.stringify(userShifts));
            } catch (error) {
                console.error("Error saving shifts:", error);
            }
        }
        
        // --- CALENDAR RENDERING ---

        function renderCalendar() {
            const date = new Date(currentYear, currentMonth, 1);
            const monthYearDisplay = document.getElementById('current-month-year');
            const grid = document.getElementById('calendar-grid');
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            monthYearDisplay.textContent = monthName;
            grid.innerHTML = '';
            
            // Adjust start day to be Monday (1) through Sunday (7)
            let startDay = date.getDay(); // 0 (Sun) - 6 (Sat)
            startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Mon=0, ..., Sun=6 for grid

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Add leading disabled days (padding)
            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += '<div class="calendar-day day-disabled"></div>';
            }

            // Render actual days
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const shift = userShifts[dateStr];
                const className = getShiftClass(shift, new Date(dateStr));
                
                let shiftInfoHtml = '';
                if (shift) {
                    const paidHours = formatHours(shift.totalPaidMinutes);
                    shiftInfoHtml = `
                        <div class="mt-1 text-xs font-semibold text-gray-800">${shift.shiftType}</div>
                        <div class="text-xs text-indigo-700">${paidHours} hrs</div>
                    `;
                }

                grid.innerHTML += `
                    <div class="calendar-day ${className}" data-date="${dateStr}" onclick="showShiftModal('${dateStr}')">
                        <span class="font-bold text-lg">${i}</span>
                        ${shiftInfoHtml}
                    </div>
                `;
            }
            
            // Update clear button text
            document.getElementById('clear-month-text').textContent = monthName + "'s";
        }

        function getShiftClass(shift, date) {
            if (!shift) {
                return 'bg-white';
            }
            
            const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
            
            switch (shift.shiftType) {
                case 'Standard':
                    // Check for weekend (Sat or Sun)
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        return 'shift-weekend-default'; // Light Orange
                    }
                    // Check for deviation (which means it's modified)
                    const isModified = shift.earlyStartMinutes > 0 || shift.extraTimeWorkedMinutes > 0 || shift.lateStartMinutes > 0 || shift.earlyFinishMinutes > 0;
                    return isModified ? 'shift-standard-modified' : 'shift-standard-default'; // Darker Green / Light Green
                case 'Overtime':
                    return 'shift-overtime-default'; // Light Pink
                case 'Bank Holiday':
                    return 'shift-bank-holiday'; // Light Grey (Standard Hours BH)
                case 'Bank Holiday Overtime':
                    return 'shift-bh-ot-default'; // Light Purple
                default:
                    return 'bg-white';
            }
        }
        
        // --- SHIFT MODAL LOGIC ---

        window.showShiftModal = function(dateStr) {
            if (!userProfile.name || !userProfile.payrollNumber) {
                showMessageBox("Input Required", "Please save your Name and Payroll Number in the profile section first.", true);
                return;
            }
            selectedDate = dateStr;
            const date = new Date(dateStr + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
            
            document.getElementById('modal-date-display').textContent = `Shift Details for ${date.toDateString()}`;
            
            const shift = userShifts[dateStr];
            const form = document.getElementById('shift-form');
            const deleteBtn = document.getElementById('delete-shift-btn');

            if (shift) {
                // Load existing shift data
                document.getElementById('startTime').value = shift.startTime;
                document.getElementById('finishTime').value = shift.finishTime;
                document.getElementById('breaksCount').value = shift.breaksCount;
                document.querySelector(`input[name="shiftType"][value="${shift.shiftType}"]`).checked = true;
                deleteBtn.classList.remove('hidden');
                
                // Save deviation data to the shift object (it's loaded via loadInitialData and used in calculateEnhancements)
                shift.deviation = {
                    earlyStartEnhancement: shift.earlyStartEnhancement,
                    lateFinishEnhancement: shift.lateFinishEnhancement,
                    lateStartAdjustment: shift.lateStartAdjustment,
                    earlyFinishAdjustment: shift.earlyFinishAdjustment
                };
            } else {
                // Reset form for new shift
                form.reset();
                // Set default times
                document.getElementById('startTime').value = '07:20';
                document.getElementById('finishTime').value = '20:30';
                document.getElementById('breaksCount').value = '2';
                // Reset deviation data cache on the shift object
                if (userShifts[dateStr]) {
                    delete userShifts[dateStr].deviation;
                }
                deleteBtn.classList.add('hidden');
            }
            
            // Add submit listener (ensures it's not duplicated)
            form.onsubmit = handleSaveShift;

            // Run initial calculation to populate the summary based on form state
            calculateEnhancements(); 
            
            document.getElementById('shift-modal').classList.remove('hidden');
        }

        window.closeShiftModal = function() {
            document.getElementById('shift-modal').classList.add('hidden');
            selectedDate = null;
        }
        
        window.clearAllShifts = function() {
            const yearMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const shiftsToKeep = {};
            
            // Copy shifts that do *not* belong to the current month
            Object.keys(userShifts).forEach(dateStr => {
                if (!dateStr.startsWith(yearMonthPrefix)) {
                    shiftsToKeep[dateStr] = userShifts[dateStr];
                }
            });
            
            if (Object.keys(userShifts).length === Object.keys(shiftsToKeep).length) {
                showMessageBox("No Shifts", "There are no shifts recorded for the current month.", true);
                return;
            }

            if (confirm(`Are you sure you want to delete ALL shifts for the current month (${new Date(currentYear, currentMonth, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})? This action cannot be undone.`)) {
                userShifts = shiftsToKeep;
                saveShiftsToLocalStorage();
                showMessageBox("Success", "All shifts for the current month have been deleted.", true);
                renderCalendar();
            }
        }
        // --- PRINT SCALE MANAGEMENT --- 
        /**
         * @description Updates the global print scale factor and saves it to local storage.
         */
        window.changePrintScale = function() {
            const scaleInput = document.getElementById('current-print-scale');
            let newScalePercent = parseInt(scaleInput.value, 10);

            if (isNaN(newScalePercent) || newScalePercent < 10 || newScalePercent > 200) {
                alert("Please enter a valid percentage between 10 and 200.");
                scaleInput.value = (PRINT_SCALE_FACTOR * 100).toFixed(0); // Reset to current value
                return;
            }

            // Convert percentage (e.g., 73) to a factor (0.73)
            PRINT_SCALE_FACTOR = newScalePercent / 100;

            // Save the new factor to Local Storage
            localStorage.setItem('printScaleFactor', PRINT_SCALE_FACTOR.toFixed(2));
            alert(`Print scale set to ${newScalePercent}%. This will be used when generating the PDF report.`);
        }

        /**
         * @description Resets the print scale to the device-specific default.
         */
        window.resetPrintScale = function() {
            const defaultScale = isAppleDevice ? APPLE_SCALE : DEFAULT_SCALE;
            PRINT_SCALE_FACTOR = defaultScale;
            localStorage.removeItem('printScaleFactor'); // Remove custom setting

            const scaleInput = document.getElementById('current-print-scale');
            scaleInput.value = (defaultScale * 100).toFixed(0);
            alert(`Print scale reset to the default of ${(defaultScale * 100).toFixed(0)}% for your device.`);
        }
        

        // --- CORE CALCULATIONS ---
        
        /**
         * @description The main function to calculate shift enhancements and total paid minutes.
         * Called on modal open, and on form change (time, breaks, shift type).
         */
        window.calculateEnhancements = function() {
            if (!selectedDate) return;

            const shiftType = document.querySelector('input[name="shiftType"]:checked').value;
            const startTimeStr = document.getElementById('startTime').value;
            const finishTimeStr = document.getElementById('finishTime').value;
            const breaksCount = parseInt(document.getElementById('breaksCount').value, 10);
            const deviationData = userShifts[selectedDate]?.deviation || {};
            
            if (!startTimeStr || !finishTimeStr) {
                 document.getElementById('enhancement-display').innerHTML = '<p class="text-red-600">Please enter valid start and finish times.</p>';
                 return;
            }

            // --- Time Conversions ---
            const startMinutes = timeToMinutes(startTimeStr);
            const finishMinutes = timeToMinutes(finishTimeStr);

            // --- Breaks Management ---
            const breakSection = document.getElementById('breaks-section');
            // If shift is short (e.g., starts after 13:00 or finishes before 18:00), offer 0 or 1 break, otherwise fix to 2.
            if (startMinutes > timeToMinutes('13:00') || finishMinutes < timeToMinutes('18:00')) {
                breakSection.classList.remove('hidden');
            } else {
                breakSection.classList.add('hidden');
                document.getElementById('breaksCount').value = '2'; // Auto-reset breaks to 2
            }
            const totalBreaksMinutes = breaksCount * 20;


            // Calculate total shift minutes, handling shifts that cross midnight
            let totalShiftMinutes = finishMinutes > startMinutes ? finishMinutes - startMinutes : (1440 - startMinutes) + finishMinutes;

            // --- Primary Calculations ---
            const enhancements = {
                // Time worked *before* 07:20 
                earlyStartMinutes: Math.max(0, DEFAULT_START_TIME_MINUTES - startMinutes),
                // Time *not* worked *after* 07:20 (a deficit)
                lateStartMinutes: Math.max(0, startMinutes - DEFAULT_START_TIME_MINUTES),
                // Time *not* worked *before* 20:30 (a deficit)
                earlyFinishMinutes: Math.max(0, DEFAULT_END_TIME_MINUTES - finishMinutes),
                // Time worked *after* 20:30 (an excess)
                extraTimeWorkedMinutes: Math.max(0, finishMinutes - DEFAULT_END_TIME_MINUTES),
                
                nightDuty: 0,
                weekendEnhancement: 0,
                bankHolidayEnhancement: 0,
                
                totalPaidMinutes: Math.max(0, totalShiftMinutes - totalBreaksMinutes),
            };

            const date = new Date(selectedDate);
            const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
            const isStandardType = shiftType === 'Standard' || shiftType === 'Bank Holiday';
            const isOvertimeType = shiftType === 'Overtime' || shiftType === 'Bank Holiday Overtime';

            // --- 1. Night Duty Calculation (20:00 to 20:30, applies to Standard and Bank Holiday Standard) ---
            if (isStandardType && dayOfWeek >= 1 && dayOfWeek <= 5) { // Mon-Fri (Night Duty only applies Mon-Fri 20:00-20:30)
                // Night duty is 20:00 to 20:30 (30 minutes)
                const nightStart = NIGHT_DUTY_START_MINUTES; // 20:00 (1200 min)
                const nightEnd = NIGHT_DUTY_END_MINUTES;     // 20:30 (1230 min)
                
                // Night duty is paid if the shift includes the window 20:00-20:30
                if (startMinutes <= nightStart && finishMinutes >= nightEnd) {
                    // Full 30 minutes
                    enhancements.nightDuty = 30;
                } else if (startMinutes < nightEnd && finishMinutes > nightEnd) {
                    // If start is after 20:00 but before 20:30, calculate portion of night duty
                    enhancements.nightDuty = nightEnd - Math.max(startMinutes, nightStart);
                } else if (finishMinutes > nightStart && finishMinutes < nightEnd) {
                    // If finish is after 20:00 but before 20:30, calculate portion of night duty
                    enhancements.nightDuty = Math.min(finishMinutes, nightEnd) - nightStart;
                }
                enhancements.nightDuty = Math.max(0, enhancements.nightDuty);
            }
            
            // --- 2. Weekend/BH Enhancement Calculation (Applies to Standard Shifts) ---
            if (shiftType === 'Standard') {
                if (dayOfWeek === 6) { // Saturday
                    // If it's a standard shift on a Saturday, the entire paid shift is a weekend enhancement
                    enhancements.weekendEnhancement = enhancements.totalPaidMinutes;
                } else if (dayOfWeek === 0) { // Sunday
                     // If it's a standard shift on a Sunday, the entire paid shift is a weekend enhancement
                    enhancements.weekendEnhancement = enhancements.totalPaidMinutes;
                }
            } else if (shiftType === 'Bank Holiday') {
                // If it's a Bank Holiday standard shift, the entire paid shift is a BH enhancement
                enhancements.bankHolidayEnhancement = enhancements.totalPaidMinutes;
            }


            // --- 3. Deviation / TOIL / OT Setup ---
            // These objects will be attached to the final shift object
            const deviationSetup = {
                // Default settings for deviations
                earlyStartEnhancement: deviationData.earlyStartEnhancement || 'Toil', 
                lateFinishEnhancement: deviationData.lateFinishEnhancement || 'Toil',
                lateStartAdjustment: deviationData.lateStartAdjustment || 'Neg Toil',
                earlyFinishAdjustment: deviationData.earlyFinishAdjustment || 'Neg Toil',
            };
            
            // --- Display Section Generation ---
            
            const displayDiv = document.getElementById('enhancement-display');
            let html = `
                <p>Total Shift Duration (incl. breaks): <span class="font-bold">${formatHours(totalShiftMinutes)} hrs</span></p>
                <p>Total Breaks (Unpaid): <span class="font-bold">${formatHours(totalBreaksMinutes)} hrs</span></p>
                <hr class="my-1 border-indigo-200">
                <p class="text-lg font-bold">Total Paid Time: <span class="font-bold">${formatHours(enhancements.totalPaidMinutes)} hrs</span></p>
            `;

            // Display Shift Enhancements (Unsocial Hours)
            if (enhancements.nightDuty > 0) {
                 html += `<p> Night Duty Enhancement (Mon-Fri 20:00-20:30): <span class="font-bold">${formatHours(enhancements.nightDuty)} hrs</span></p>`;
            }
            if (enhancements.weekendEnhancement > 0) {
                 html += `<p> Weekend Enhancement (Sat/Sun): <span class="font-bold">${formatHours(enhancements.weekendEnhancement)} hrs</span></p>`;
            }
             if (enhancements.bankHolidayEnhancement > 0) {
                 html += `<p> Bank Holiday Enhancement: <span class="font-bold">${formatHours(enhancements.bankHolidayEnhancement)} hrs</span></p>`;
            }
            if (isOvertimeType) {
                 html += `<p class="${shiftType.includes('Bank') ? 'text-purple-700' : 'text-red-700'} mt-2">All paid time recorded as: <strong>${shiftType.toUpperCase()}</strong></p>`;
            }
            
            
            // --- Deviation Selector Generation ---
            const selectorContainer = document.getElementById('deviation-selectors');
            selectorContainer.innerHTML = '<p class="font-bold text-lg mb-2 text-yellow-800">Time Deviation Management</p>'; // Reset
            const deviationText = [];

            function generateSelector(id, label, options, defaultValue) {
                let optionsHtml = options.map(opt => `<option value="${opt.value}" ${opt.value === defaultValue ? 'selected' : ''}>${opt.label}</option>`
                ).join('');
                return `
                    <div>
                        <label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label>
                        <select id="${id}" name="${id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                            ${optionsHtml}
                        </select>
                    </div>
                `;
            }

            // Only show deviation selectors for Standard / Bank Holiday standard shifts
            if (shiftType === 'Standard' || shiftType === 'Bank Holiday') {
                selectorContainer.classList.remove('hidden');

                // Early Start
                if (enhancements.earlyStartMinutes > 0) {
                    const minutes = enhancements.earlyStartMinutes;
                    deviationText.push(` Early Start (Pre 07:20): +${formatHours(minutes)} hrs`);
                    selectorContainer.innerHTML += generateSelector(
                        'earlyStartEnhancement', 
                        `Early Start (${formatHours(minutes)} hrs):`,
                        [
                            { value: 'Toil', label: '1. Record as Toil' },
                            { value: 'Overtime', label: '2. Record as Overtime' },
                        ],
                        deviationData.earlyStartEnhancement // Pass default from loaded data
                    );
                    // Update deviationSetup with the current selected value
                    deviationSetup.earlyStartEnhancement = document.getElementById('earlyStartEnhancement')?.value || deviationSetup.earlyStartEnhancement;
                }
                
                // Late Finish
                if (enhancements.extraTimeWorkedMinutes > 0) {
                    const minutes = enhancements.extraTimeWorkedMinutes;
                    deviationText.push(` Late Finish (Post 20:30): +${formatHours(minutes)} hrs`);
                    selectorContainer.innerHTML += generateSelector(
                        'lateFinishEnhancement', 
                        `Late Finish (${formatHours(minutes)} hrs):`,
                        [
                            { value: 'Toil', label: '1. Record as Toil' },
                            { value: 'Overtime', label: '2. Record as Overtime' },
                        ],
                        deviationData.lateFinishEnhancement
                    );
                    deviationSetup.lateFinishEnhancement = document.getElementById('lateFinishEnhancement')?.value || deviationSetup.lateFinishEnhancement;
                }

                // Late Start
                if (enhancements.lateStartMinutes > 0) {
                    const minutes = enhancements.lateStartMinutes;
                    deviationText.push(` Late Start: -${formatHours(minutes)} hrs`);
                    selectorContainer.innerHTML += generateSelector(
                        'lateStartAdjustment', 
                        `Late Start (${formatHours(minutes)} hrs):`,
                        [
                            { value: 'Neg Toil', label: '1. Late start for negative toil' },
                            { value: 'AL', label: '2. Late start for annual leave' },
                        ],
                        deviationData.lateStartAdjustment
                    );
                    deviationSetup.lateStartAdjustment = document.getElementById('lateStartAdjustment')?.value || deviationSetup.lateStartAdjustment;
                }

                // Early Finish
                if (enhancements.earlyFinishMinutes > 0) {
                    const minutes = enhancements.earlyFinishMinutes;
                    deviationText.push(` Early Finish (Pre 20:30): -${formatHours(minutes)} hrs`);
                    selectorContainer.innerHTML += generateSelector(
                        'earlyFinishAdjustment', 
                        `Early Finish (${formatHours(minutes)} hrs):`,
                        [
                            { value: 'Neg Toil', label: '1. Early finish for negative toil' },
                            { value: 'AL', label: '2. Early finish for annual leave' },
                        ],
                        deviationData.earlyFinishAdjustment
                    );
                    deviationSetup.earlyFinishAdjustment = document.getElementById('earlyFinishAdjustment')?.value || deviationSetup.earlyFinishAdjustment;
                }
                
                // Add Deviation Summary to Display
                if (deviationText.length > 0) {
                     html += `<hr class="my-1 border-indigo-200"><p class="font-bold mt-2 text-md text-indigo-700">Time Deviations:</p>` + deviationText.map(t => `<p>${t}</p>`).join('');
                }
                
                // Hide the main deviation container if no deviations occurred
                if (deviationText.length === 0) {
                    selectorContainer.classList.add('hidden');
                } else {
                    selectorContainer.classList.remove('hidden');
                }

            } else if (isOvertimeType) {
                // Hide deviation selectors completely for Overtime shifts
                selectorContainer.classList.add('hidden');
                // Ensure the base enhancements are zero for overtime shifts to prevent double-counting
                // All minutes are simply added to the 'totalPaidMinutes' which becomes the OT time.
                enhancements.earlyStartMinutes = 0;
                enhancements.extraTimeWorkedMinutes = 0; 
                enhancements.lateStartMinutes = 0; 
                enhancements.earlyFinishMinutes = 0;
                
            } else {
                // No shift selected or other state
                selectorContainer.classList.add('hidden');
            }
            
            displayDiv.innerHTML = html;

            // Combine all data to be stored and pass to form data
            const calculatedData = {
                ...enhancements,
                ...deviationSetup, // Includes the final deviation choices
            };

            // Store the calculated data in a data attribute on the form for submission
            document.getElementById('shift-form').dataset.calculated = JSON.stringify(calculatedData);
            
            
        } // End calculateEnhancements

        // --- SHIFT DATA HANDLING (LOCAL SAVE/DELETE) ---

        window.handleSaveShift = async function(event) {
            event.preventDefault();

            if (!selectedDate || !userProfile.name) {
                showMessageBox("Error", "Please select a date and save your profile (Name and Payroll No.) first.", true);
                return;
            }

            const shiftType = document.querySelector('input[name="shiftType"]:checked').value;
            const startTime = document.getElementById('startTime').value;
            const finishTime = document.getElementById('finishTime').value;
            const breaksCount = parseInt(document.getElementById('breaksCount').value, 10);
            
            const calculatedData = JSON.parse(document.getElementById('shift-form').dataset.calculated || '{}');

            // The calculatedData now includes deviation selectors via the calculateEnhancements function
            const newShift = {
                shiftType,
                startTime,
                finishTime,
                breaksCount,
                ...calculatedData,
                userName: userProfile.name,
                payrollNumber: userProfile.payrollNumber,
                userEmail: userProfile.userEmail,
                date: selectedDate,
                // NEW: Include contractedHours in the shift record (for future reporting/calculation flexibility)
                contractedHours: userProfile.contractedHours
            };

            userShifts[selectedDate] = newShift;
            saveShiftsToLocalStorage();

            showMessageBox("Success", `Shift for ${selectedDate} saved as ${shiftType}.`, true);
            closeShiftModal();
            renderCalendar();
        }


        window.deleteShift = function() {
            if (!selectedDate || !userShifts[selectedDate]) {
                return;
            }

            if (confirm(`Are you sure you want to delete the shift for ${selectedDate}?`)) {
                delete userShifts[selectedDate];
                saveShiftsToLocalStorage();
                showMessageBox("Success", `Shift for ${selectedDate} has been deleted.`, true);
                closeShiftModal();
                renderCalendar();
            }
        }
        
        // --- REPORT GENERATION ---
        
        window.generateReport = function() {
            // Check for profile first
            if (!userProfile.name || !userProfile.payrollNumber) {
                showMessageBox("Error", "Please save your Name and Payroll Number in the profile section first.", true);
                return;
            }
            
            // Show loading message while calculation runs
            showMessageBox("Generating Report", "Calculating totals for the month. Please wait...", false);

            setTimeout(() => {
                const yearMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const monthName = new Date(currentYear, currentMonth, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Get all shifts for the month (used for the detailed shift log)
                const shiftsInMonth = Object.keys(userShifts)
                    .filter(dateStr => dateStr.startsWith(yearMonthPrefix))
                    .sort()
                    .map(dateStr => userShifts[dateStr]);

                const totals = {
                    uhSat: 0, uhSun: 0, uhNight: 0, uhBH: 0, // Unsocial Hours Totals
                    extraHoursWorked: 0, // Raw extra time (pre 20:30>)
                    otMonFri: 0, otSat: 0, otSun: 0, otBH: 0, // Overtime Totals
                    totalPaidMinutes: 0, // Sum of all paid time
                    toilAccrued: 0, // Early start/Late finish assigned to TOIL
                    toilUsed: 0, // Late start/Early finish assigned to Neg TOIL
                    annualLeaveUsed: 0, // Late start/Early finish assigned to AL
                };

                const detailedPrintShifts = [];
                
                // --- 1. Populate Totals and Print Detail (Iterates ALL days of the month) ---
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = userShifts[dateStr];

                    // Create a base shift object for print form, even if no shift exists (empty row)
                    const baseShift = {
                        date: dateStr,
                        dayOfMonth: day,
                        shiftType: shift ? shift.shiftType : 'None',
                        startTime: shift ? shift.startTime : '',
                        finishTime: shift ? shift.finishTime : '',
                        // Unsocial Hours Enhancements
                        uhSat: 0, uhSun: 0, uhNight: 0, uhBH: 0,
                        // Extra Hours/OT
                        extraHours: 0, // Time worked over 12.5 hrs default shift
                        otMonFri: 0, otSat: 0, otSun: 0, otBH: 0,
                    };

                    if (shift) {
                        const date = new Date(dateStr);
                        const dayOfWeek = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                        
                        const totalPaidMinutes = shift.totalPaidMinutes || 0;
                        totals.totalPaidMinutes += totalPaidMinutes;

                        // 1. Core Enhancements (Unsocial Hours)
                        if (shift.shiftType === 'Bank Holiday') {
                            baseShift.uhBH = totalPaidMinutes;
                            totals.uhBH += totalPaidMinutes;
                        } else if (shift.shiftType === 'Standard') {
                            // Apply night duty if applicable (already calculated and stored in shift.nightDuty)
                            baseShift.uhNight = shift.nightDuty || 0;
                            totals.uhNight += shift.nightDuty || 0; // Add to overall night total
                            
                            if (dayOfWeek === 6) { // Saturday
                                baseShift.uhSat = totalPaidMinutes;
                                totals.uhSat += totalPaidMinutes;
                            } else if (dayOfWeek === 0) { // Sunday
                                baseShift.uhSun = totalPaidMinutes;
                                totals.uhSun += totalPaidMinutes;
                            }
                        }

                        // 2. Extra Hours / OT / TOIL / AL Logic (Based on Deviations)
                        if (shift.shiftType === 'Standard' || shift.shiftType === 'Bank Holiday') {

                            // **Extra Hours (Post 20:30)**
                            // Only record under "Extra Hours" column if explicitly set to Overtime (otherwise it's TOIL)
                            if (shift.lateFinishEnhancement === 'Overtime') {
                                 baseShift.extraHours = shift.extraTimeWorkedMinutes || 0;
                                 totals.extraHoursWorked += baseShift.extraHours;
                            } else if (shift.lateFinishEnhancement === 'Toil') {
                                 totals.toilAccrued += shift.extraTimeWorkedMinutes || 0;
                            }
                            
                            // **Early Start (Pre 07:20)**
                            if (shift.earlyStartEnhancement === 'Overtime') {
                                // If early start is OT, it's counted as OT Mon-Fri/Sat/Sun based on day
                                if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Mon-Fri
                                    baseShift.otMonFri += shift.earlyStartMinutes || 0;
                                    totals.otMonFri += shift.earlyStartMinutes || 0;
                                } else if (dayOfWeek === 6) { // Sat
                                    baseShift.otSat += shift.earlyStartMinutes || 0;
                                    totals.otSat += shift.earlyStartMinutes || 0;
                                } else if (dayOfWeek === 0) { // Sun
                                    baseShift.otSun += shift.earlyStartMinutes || 0;
                                    totals.otSun += shift.earlyStartMinutes || 0;
                                }
                            } else if (shift.earlyStartEnhancement === 'Toil') {
                                totals.toilAccrued += shift.earlyStartMinutes || 0;
                            }


                            // **Deviation Adjustments (Late Start / Early Finish)**
                            // These are *negative* adjustments, affecting TOIL or AL totals only, not printed in the table
                            if (shift.lateStartAdjustment === 'Neg Toil') {
                                totals.toilUsed += shift.lateStartMinutes || 0;
                            }
                            if (shift.earlyFinishAdjustment === 'Neg Toil') {
                                totals.toilUsed += shift.earlyFinishMinutes || 0;
                            }
                            if (shift.lateStartAdjustment === 'AL') {
                                totals.annualLeaveUsed += shift.lateStartMinutes || 0;
                            }
                            if (shift.earlyFinishAdjustment === 'AL') {
                                totals.annualLeaveUsed += shift.earlyFinishMinutes || 0;
                            }

                        } else if (shift.shiftType === 'Overtime') {
                            // General Overtime (The entire paid shift is OT)
                            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Mon-Fri
                                baseShift.otMonFri = totalPaidMinutes;
                                totals.otMonFri += totalPaidMinutes;
                            } else if (dayOfWeek === 6) { // Sat
                                baseShift.otSat = totalPaidMinutes;
                                totals.otSat += totalPaidMinutes;
                            } else if (dayOfWeek === 0) { // Sun
                                baseShift.otSun = totalPaidMinutes;
                                totals.otSun += totalPaidMinutes;
                            }
                        } else if (shift.shiftType === 'Bank Holiday Overtime') {
                            // Bank Holiday Overtime (The entire paid shift is BH OT)
                            baseShift.otBH = totalPaidMinutes;
                            totals.otBH += totalPaidMinutes;
                        }
                    } // End if (shift)

                    detailedPrintShifts.push(baseShift);
                }

                // --- 2. Render Summary Table ---
                const reportBody = document.getElementById('report-table-body');
                reportBody.innerHTML = '';
                
                const reportData = [
                    // Unsocial Hours (UH)
                    { label: 'Unsocial Hrs (Sat)', value: totals.uhSat, color: 'text-orange-700', description: 'Total paid hours on Saturday for Standard Shifts.' },
                    { label: 'Unsocial Hrs (Sun)', value: totals.uhSun, color: 'text-orange-700', description: 'Total paid hours on Sunday for Standard Shifts.' },
                    { label: 'Unsocial Hrs (Night)', value: totals.uhNight, color: 'text-orange-700', description: 'Total night duty minutes (20:00-20:30 Mon-Fri) for Standard Shifts.' },
                    { label: 'Unsocial Hrs (Bank Hol)', value: totals.uhBH, color: 'text-orange-700', description: 'Total paid hours on Bank Holiday for Standard Shifts.' },
                    { label: '---', value: 0, isDivider: true },
                    // Overtime (OT)
                    { label: 'Overtime (Mon-Fri)', value: totals.otMonFri, color: 'text-red-700', description: 'Total Mon-Fri hours recorded as Overtime.' },
                    { label: 'Overtime (Sat)', value: totals.otSat, color: 'text-red-700', description: 'Total Saturday hours recorded as Overtime.' },
                    { label: 'Overtime (Sun)', value: totals.otSun, color: 'text-red-700', description: 'Total Sunday hours recorded as Overtime.' },
                    { label: 'Overtime (BH)', value: totals.otBH, color: 'text-red-700', description: 'Total Bank Holiday hours recorded as Overtime.' },
                    { label: 'Extra Time Worked (Post 20:30 OT)', value: totals.extraHoursWorked, color: 'text-red-700', description: 'Total extra hours (Post 20:30) assigned to Overtime.' },
                    { label: '---', value: 0, isDivider: true },
                    // TOIL / AL
                    { label: 'TOIL Accrued (+ Hours)', value: totals.toilAccrued, color: 'text-green-700', description: 'Hours gained from early start/late finish assigned to TOIL.' },
                    { label: 'TOIL Used (- Hours)', value: totals.toilUsed, color: 'text-red-600', description: 'Hours deducted from TOIL for late start/early finish.' },
                    { label: 'Annual Leave Used (- Hours)', value: totals.annualLeaveUsed, color: 'text-red-600', description: 'Hours deducted from AL for late start/early finish.' },
                    { label: '---', value: 0, isDivider: true },
                    // Grand Total
                    { label: 'GRAND TOTAL Paid Hours', value: totals.totalPaidMinutes, color: 'text-gray-900', description: 'Total paid hours for the month (used for contracted hours check).', isTotal: true },
                ];

                reportData.forEach(item => {
                    if (item.isDivider) {
                        reportBody.innerHTML += `<tr><td colspan="3" class="h-4 border-b-2 border-gray-300"></td></tr>`;
                        return;
                    }
                    reportBody.innerHTML += `
                        <tr class="${item.isTotal ? 'bg-indigo-100 font-bold' : ''}">
                            <td class="py-2 px-2 text-sm font-medium ${item.color}">${item.label}</td>
                            <td class="py-2 px-2 text-sm font-bold text-right ${item.color}">${formatHours(item.value)}</td>
                            <td class="py-2 px-2 text-xs text-gray-500 hidden md:table-cell">${item.description}</td>
                        </tr>
                    `;
                });


                // --- 3. Render Detailed Log ---
                const detailedList = document.getElementById('detailed-shift-list');
                detailedList.innerHTML = '';
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                if (shiftsInMonth.length === 0) {
                    detailedList.innerHTML = '<p class="text-center text-gray-500 p-4">No shifts recorded for this month.</p>';
                } else {
                    shiftsInMonth.forEach(shift => {
                        const dateObj = new Date(shift.date + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
                        const dayOfWeek = dayNames[dateObj.getDay()];
                        
                        const paidHoursText = `<span class="text-indigo-600 font-semibold">${formatHours(shift.totalPaidMinutes)} Paid Hrs</span>`;
                        
                        let toilText = [];
                        if (shift.earlyStartMinutes > 0 && shift.earlyStartEnhancement === 'Toil') {
                            toilText.push(`+${formatHours(shift.earlyStartMinutes)} TOIL (Early Start)`);
                        }
                        if (shift.extraTimeWorkedMinutes > 0 && shift.lateFinishEnhancement === 'Toil') {
                            toilText.push(`+${formatHours(shift.extraTimeWorkedMinutes)} TOIL (Late Finish)`);
                        }
                        if (shift.lateStartMinutes > 0 && shift.lateStartAdjustment === 'Neg Toil') {
                            toilText.push(`-${formatHours(shift.lateStartMinutes)} TOIL (Late Start)`);
                        }
                        if (shift.earlyFinishMinutes > 0 && shift.earlyFinishAdjustment === 'Neg Toil') {
                            toilText.push(`-${formatHours(shift.earlyFinishMinutes)} TOIL (Early Finish)`);
                        }
                        toilText = toilText.length > 0 ? `<span class="text-green-700">${toilText.join(' / ')}</span>` : '';

                        let otText = [];
                         // OT from shift type (Overtime / BH Overtime)
                        if (shift.shiftType.includes('Overtime')) {
                            otText.push(`${formatHours(shift.totalPaidMinutes)} OT`);
                        }
                        // OT from deviations (Early start / Late finish)
                        if (shift.earlyStartMinutes > 0 && shift.earlyStartEnhancement === 'Overtime') {
                            otText.push(`+${formatHours(shift.earlyStartMinutes)} OT (Early Start)`);
                        }
                        if (shift.extraTimeWorkedMinutes > 0 && shift.lateFinishEnhancement === 'Overtime') {
                            otText.push(`+${formatHours(shift.extraTimeWorkedMinutes)} OT (Late Finish)`);
                        }
                        otText = otText.length > 0 ? `<span class="text-red-600">${otText.join(' / ')}</span>` : '';


                        let enhancements = [];
                        if (shift.nightDuty > 0) enhancements.push('Night Duty');
                        if (shift.weekendEnhancement > 0 && shift.shiftType === 'Standard') enhancements.push('Weekend Hrs');
                        if (shift.bankHolidayEnhancement > 0 && shift.shiftType === 'Bank Holiday') enhancements.push('BH Hrs');

                        detailedList.innerHTML += `
                            <div class="p-3 rounded-xl border border-gray-300 bg-white shadow-sm">
                                <p class="font-bold text-base text-gray-800">${dateObj.toDateString()} (${dayOfWeek})</p>
                                <p class="text-xs text-gray-600">
                                    <strong>${shift.shiftType}</strong>: ${shift.startTime} - ${shift.finishTime} (${shift.breaksCount} breaks)
                                </p>
                                <div class="mt-1 text-xs space-x-3">
                                    ${paidHoursText} ${toilText} ${otText}
                                    ${enhancements.length > 0 ? `<span class="text-purple-600">${enhancements.join(', ')}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }


                // --- 4. Cache and Display Report ---
                currentReportData = { totals, shiftsInMonth: detailedPrintShifts, monthName }; // Cache the generated data
                
                document.getElementById('report-title').textContent = `Monthly Shift Report for ${monthName}`;
                document.getElementById('report-period').textContent = `Generated on ${new Date().toLocaleDateString('en-US', { dateStyle: 'medium' })}`;
                
                hideMessageBox(); // Hide the loading message
                document.getElementById('report-modal').classList.remove('hidden');

            }, 50); // Small delay for message box to show
        }


/**
 * @description Renders the report content into a print-friendly HTML document and triggers the print dialog.
 * RENAMED: This is the function that executes the actual browser print command
 */
window.executePrintReport = function() {
    const { shiftsInMonth, monthName } = currentReportData;
    const profile = userProfile;
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    if (!monthName) {
        alert("Please generate the report first before attempting to print.");
        return;
    }

    // Use the constant PRINT_SCALE_FACTOR to set the CSS
    // Generate the CSS string dynamically using the calculated factor (e.g., 0.73 or 1.0)
    const printScaleStyle = `
        @page { 
            size: A4 portrait; /* MODIFIED: Changed from landscape to portrait */
            margin: 10mm;
        }
        body { 
            transform: scale(${PRINT_SCALE_FACTOR}); 
            transform-origin: top left; 
            /* MODIFIED: Removed width compensation for landscape */
            -webkit-print-color-adjust: exact; 
            color-adjust: exact;
            margin: 0;
            padding: 0;
        }
        /* Further styles from the original document */
        * {
            box-sizing: border-box;
        }
        .print-page {
            max-width: 780px; /* MODIFIED: Adjusted max-width to fit A4 portrait */
            margin: 0 auto;
            padding: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 9pt;
            color: #333;
            margin: 0;
            padding: 0;
        } 
        th, td { -webkit-print-color-adjust: exact; color-adjust: exact; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; } 
        .header-row img { max-width: 150px; height: auto; }
        h1 { font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .details { margin-bottom: 10px; line-height: 1.4; } 
        .sub-heading { font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
        .instructions { margin-left: 10px; margin-bottom: 15px; font-size: 0.9em; } 
        .instructions li { margin-bottom: 5px; } 
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.8em; } 
        th { background-color: #ddd; font-weight: bold; padding: 4px 2px; border: 1px solid #000; text-align: center; vertical-align: middle; line-height: 1.1; } 
        td { border-right: 1px solid #000; border-bottom: 1px dashed #ccc; padding: 2px; text-align: center; vertical-align: top; }
        td:first-child { border-left: 1px solid #000; } 
        tr:last-child td { border-bottom: 1px solid #000; }
        .fill-line { display: inline-block; border-bottom: 1px solid #000; width: 250px; text-align: left; padding: 0 5px; }
        .blank-signature-line { display: inline-block; border-bottom: 1px solid #000; text-align: left; padding: 0 5px; }
    `;

    // 1. Build the Table Rows
    const tableRows = shiftsInMonth.map(shift => {
        const date = new Date(shift.date + 'T00:00:00');
        const day = shift.dayOfMonth;
        const dayName = dayNames[date.getDay()];

        // Print every day in the month
        const topBorderStyle = day === 1 ? 'border-top: 1px solid #000;' : '';

        return `
            <tr>
                <td style="width: 5%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${day}</td>
                <td style="width: 5%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${dayName}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${shift.startTime}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${shift.finishTime}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhSat)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhSun)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhNight)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhBH)}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.extraHours)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otMonFri)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otSat)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otSun)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otBH)}</td>
            </tr>
        `;
    }).join('');

    // 2. Build the Total Row
    const totalRow = `
        <tr style="font-weight: bold; background-color: #ddd;">
            <td colspan="4" style="text-align: right; border: 1px solid #000; padding: 4px 2px;">TOTALS:</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhSat)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhSun)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhNight)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhBH)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.extraHoursWorked)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otMonFri)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otSat)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otSun)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otBH)}</td>
        </tr>
    `;

    // 3. Construct the full print content HTML
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Shift Report - ${monthName}</title>
            <style>
                ${printScaleStyle}
            </style>
        </head>
        <body>
            <div class="print-page">
                
			<div class="header-row" style="display: flex; justify-content: space-between; align-items: center;">
				<div style="width: auto; flex-grow: 1; text-align: left;">
					<h1 style="
						white-space: nowrap; 
						overflow: hidden; 
						text-overflow: ellipsis; 
						/* Optional: Reduce Font Size if necessary */
						font-size: 1.1em; 
						margin: 0;
							">UNSOCIAL HOURS & OVERTIME CLAIM FORM - MONTHLY PAID STAFF (non-medical)</h1>
				</div>

	
				<div style="width: 160px; flex-shrink: 0; text-align: right; margin-left: 10px;">
					<img src="${LOGO_BASE64_SRC}"
					alt="Sheffield Teaching Hospitals NHS Foundation Trust Logo" 
					style="max-width: 150px; height: auto;">
					<p style="font-size: 8px; margin-top: 2px; color: #555;">STH NHS Foundation Trust Logo</p>
				</div>
			</div>
                
                <div class="details" style="font-size: 0.9em;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="display: inline-block; white-space: nowrap;">
            <span style="font-weight: bold; padding-right: 5px;">Name:</span>
            <span class="fill-line">${profile.name}</span>
        </span>
        <span style="display: inline-block; white-space: nowrap;">
            <span style="font-weight: bold; padding-right: 5px;">Dept:</span>
            <span class="fill-line"> MIMP </span>
        </span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="display: inline-block; white-space: nowrap;">
            <span style="font-weight: bold; padding-right: 5px;">Assignment No:</span>
            <span class="fill-line">${profile.payrollNumber}</span>
        </span>
        <span style="display: inline-block; white-space: nowrap;">
            <span style="display: inline-block; text-align: right; font-weight: bold;">Claim for the month of:</span>
            <span class="fill-line">${monthName}</span>
        </span>
    </div>
</div>

                <ul class="instructions">
                    <li>ONLY hours attracting payments over and above basic hours need recording on this claim form.</li>
                    <li>All hours claimed must be exclusive of meal breaks and time off in lieu (TOIL).</li>
                    <li>Claims must be received by Payroll Services by the 4th of the following month to prevent payment delay.</li>
                    <li>Please refer to the notes overleaf for guidance on completion.</li>
                </ul>

                <table>
                    <thead>
                        <tr style="background-color: #ddd;">
                            <th rowspan="2" style="width: 5%;">Day</th>
                            <th rowspan="2" style="width: 5%;">D/W</th>
                            <th rowspan="2" style="width: 8%;">Shift Start (time)</th>
                            <th rowspan="2" style="width: 8%;">Shift End (time)</th>
                            <th colspan="4">Unsocial Hours Enhancements</th>
                            <th rowspan="2" style="width: 8%;">Extra Hours (20:30>)</th>
                            <th colspan="4">Overtime (Over ${profile.contractedHours || '37.5'}hrs a week)</th>
                        </tr>
                        <tr style="background-color: #ddd;">
                            <th style="width: 6%;">Sat</th>
                            <th style="width: 6%;">Sun</th>
                            <th style="width: 6%;">Night Duty</th>
                            <th style="width: 6%;">Bank Hol</th>
                            <th style="width: 6%;">Mon-Fri</th>
                            <th style="width: 6%;">Sat</th>
                            <th style="width: 6%;">Sun</th>
                            <th style="width: 6%;">Bank Hol</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                        ${totalRow}
                    </tbody>
                </table>
                
                <h2 class="sub-heading">Declaration</h2>
                
                <div class="details" style="font-size: 0.9em;">
                    <p style="margin-bottom: 15px;">I certify that the above claim is correct and in accordance with my attendance record.</p>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <div style="width: 65%; text-align: left;">
                            <span style="font-weight: bold; padding-right: 5px;">Employee Signature:</span>
                            <span class="blank-signature-line" style="width: 230px;"></span>
                        </div>
                        <div style="width: 35%; text-align: center;">
                            <span style="font-weight: bold; padding-right: 5px;">Date:</span>
                            <span class="blank-signature-line" style="width: 120px;"></span>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <div style="width: 65%; text-align: left;">
                            <span style="font-weight: bold; padding-right: 5px;">Authorising Signature (manager):</span>
                            <span class="blank-signature-line" style="width: 210px;"></span>
                        </div>
                        <div style="width: 35%; text-align: center;">
                            <span style="font-weight: bold; padding-right: 5px;">Date:</span>
                            <span class="blank-signature-line" style="width: 120px;"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <div style="width: 65%; text-align: left;">
                            <span style="font-weight: bold; padding-right: 5px;">Manager's Name (print):</span>
                            <span class="blank-signature-line" style="width: 230px;"></span>
                        </div>
                        <div style="width: 35%; text-align: center;">
                            <span style="font-weight: bold; padding-right: 5px;">Cost centre:</span>
                            <span class="blank-signature-line" style="width: 155px;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;

    // 4. Open and Print
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

/**
 * @description Renders the print instructions dialog based on the detected device.
 */
window.showPrintInstructions = function() {
    // Ensure the report has been generated before showing instructions
    if (!currentReportData.monthName) {
        alert("Please generate the report first before attempting to print.");
        return;
    }
    
    const deviceType = classifyDeviceForInstructions();
    const modalTitle = document.getElementById('instruction-modal-title');
    const contentDiv = document.getElementById('instruction-content');
    let titleText = "Print Instructions";
    let instructionsHtml = '';

    // --- Define Instructions ---
    const commonSteps = `
        <p class="text-sm font-semibold mt-4 text-gray-800">Common Steps for All Devices:</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Select Destination:</strong> Choose 'Save as PDF' or your physical printer.</li>
            <li><strong>Layout/Orientation:</strong> Ensure 'Portrait' is selected.</li>
            <li><strong>Margins:</strong> Select 'None' or 'Minimum'.</li>
            <li><strong>Headers/Footers:</strong> Disable this option to remove page numbers/titles.</li>
        </ul>
    `;
    
    // The scale value for Apple is a known issue (0.73/73%)
    const appleInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Apple Devices (Mac/iPhone/iPad)</h4>
        <p class="text-sm">Apple devices (Safari/Chrome/Edge) sometimes apply an incorrect default scale. You may need to adjust the scale.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm font-medium">
            <li><strong>Scale:</strong> Set 'Scale' to **100%** or use the custom scale setting provided in the report modal if the content appears too small.</li>
        </ul>
    `;

    const windowsInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Windows PC (Chrome, Edge, Firefox)</h4>
        <p class="text-sm">The report is optimized for a full-page width in Portrait mode. Check your settings before printing.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Scale:</strong> Ensure 'Default', '100%', or 'Fit to page' is selected.</li>
        </ul>
    `;

    const androidInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Android Mobile/Tablet</h4>
        <p class="text-sm">Mobile printing can vary by device and browser. Please ensure the scale is appropriate to fit the full table width.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Scale:</strong> Use 'Fit to Page' or check the scale is close to 100%.</li>
        </ul>
    `;

    // --- Content Selection ---
    if (deviceType === 'Apple') {
        titleText = "Apple Print Instructions (Check Scale)";
        instructionsHtml = appleInstruction + commonSteps;
    } else if (deviceType === 'Android') {
        titleText = "Android Print Instructions";
        instructionsHtml = androidInstruction + commonSteps;
    } else { // Covers WindowsPC and OtherPC (Linux, ChromeOS)
        titleText = "PC Print Instructions";
        instructionsHtml = windowsInstruction + commonSteps;
    }

    modalTitle.textContent = titleText;
    contentDiv.innerHTML = instructionsHtml;
    document.getElementById('instruction-modal').classList.remove('hidden');
}

/**
 * @description Handler for the new modal's "Print" button. 
 * Executes the actual print function and closes both modals.
 */
window.handlePrintButtonClick = function() {
    // 1. Execute the actual print logic
    executePrintReport(); 
    // 2. Hide the instructions modal after printing is initiated
    document.getElementById('instruction-modal').classList.add('hidden');
    // 3. Hide the main report modal, as the user is done
    closeReportModal();
}

// --- MODAL UTILITIES ---
window.closeReportModal = function() {
    document.getElementById('report-modal').classList.add('hidden');
}


        // ------------------------------------

        window.changeMonth = function(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();

            loadInitialData();
        };

        // Expose functions globally for HTML
        window.saveProfile = saveProfile;
        window.showShiftModal = showShiftModal;
        window.closeShiftModal = closeShiftModal;
        window.calculateEnhancements = calculateEnhancements;
        window.deleteShift = deleteShift;
        window.generateReport = generateReport;
        window.closeReportModal = closeReportModal;
        window.editProfile = editProfile; // Expose the new function
        window.clearAllShifts = clearAllShifts; // Expose the new function
        window.showPrintInstructions = showPrintInstructions; // Expose the new instruction handler
        window.handlePrintButtonClick = handlePrintButtonClick; // Expose the print function from the modal
        window.executePrintReport = executePrintReport; // Expose the underlying print function
        window.checkCustomContractedHours = checkCustomContractedHours; // Expose the new function
    </script>
</body>
</html>



